apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-app-sli-overview
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  app-sli-overview.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": "-- Grafana --",
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "Requests per second hacia la aplicación (ingress-nginx). Filtra por namespace e ingress (si se selecciona).",
          "fieldConfig": { "defaults": { "unit": "reqps", "min": 0 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "id": 11,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "sum(rate(nginx_ingress_controller_requests{namespace=~\"$namespace\", ingress=~\"$ingress\"}[5m]))",
              "legendFormat": "RPS",
              "refId": "A"
            }
          ],
          "title": "Traffic - Requests/s (Ingress)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "Errores 5xx por segundo (ingress-nginx). Útil para SLI de disponibilidad.",
          "fieldConfig": { "defaults": { "unit": "reqps", "min": 0 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "id": 12,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "sum(rate(nginx_ingress_controller_requests{namespace=~\"$namespace\", ingress=~\"$ingress\", status=~\"5..\"}[5m]))",
              "legendFormat": "5xx RPS",
              "refId": "A"
            }
          ],
          "title": "Errors - 5xx Requests/s (Ingress)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "Latencia p95 calculada por histogram_quantile sobre buckets del ingress-nginx. Si el nombre del metric difiere, se ajusta.",
          "fieldConfig": { "defaults": { "unit": "s", "min": 0 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
          "id": 13,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(nginx_ingress_controller_request_duration_seconds_bucket{namespace=~\"$namespace\", ingress=~\"$ingress\"}[5m])) by (le))",
              "legendFormat": "p95",
              "refId": "A"
            }
          ],
          "title": "Latency - p95 (Ingress)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "Tasa de éxito (%) aproximada = 100 * (1 - 5xx/total). Representa un SLI básico de disponibilidad.",
          "fieldConfig": { "defaults": { "unit": "percent", "min": 0, "max": 100 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
          "id": 14,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "100 * (1 - (sum(rate(nginx_ingress_controller_requests{namespace=~\"$namespace\", ingress=~\"$ingress\", status=~\"5..\"}[5m])) / clamp_min(sum(rate(nginx_ingress_controller_requests{namespace=~\"$namespace\", ingress=~\"$ingress\"}[5m])), 1)))",
              "legendFormat": "success %",
              "refId": "A"
            }
          ],
          "title": "SLI - Success Rate (%)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "CPU usage por workload (aprox. por pods cuyo nombre coincide con el deployment).",
          "fieldConfig": { "defaults": { "unit": "cores", "min": 0 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
          "id": 15,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\", pod=~\"$deployment-.*\", container!=\"POD\", image!=\"\"}[5m]))",
              "legendFormat": "CPU cores",
              "refId": "A"
            }
          ],
          "title": "App Saturation - CPU (cores)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "Memoria working set por workload (aprox. por pods cuyo nombre coincide con el deployment).",
          "fieldConfig": { "defaults": { "unit": "bytes", "min": 0 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
          "id": 16,
          "options": {
            "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "sum(container_memory_working_set_bytes{namespace=~\"$namespace\", pod=~\"$deployment-.*\", container!=\"POD\", image!=\"\"})",
              "legendFormat": "Memory",
              "refId": "A"
            }
          ],
          "title": "App Saturation - Memory (working set)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "Réplicas deseadas vs disponibles del Deployment seleccionado (kube-state-metrics).",
          "fieldConfig": { "defaults": { "unit": "none", "min": 0 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
          "id": 17,
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "kube_deployment_spec_replicas{namespace=~\"$namespace\", deployment=~\"$deployment\"}",
              "legendFormat": "desired",
              "refId": "A"
            },
            {
              "expr": "kube_deployment_status_replicas_available{namespace=~\"$namespace\", deployment=~\"$deployment\"}",
              "legendFormat": "available",
              "refId": "B"
            }
          ],
          "title": "Deployment Replicas (desired vs available)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus", "name": "Prometheus" },
          "description": "Reinicios de contenedores (30m) en el namespace. Útil para detectar inestabilidad.",
          "fieldConfig": { "defaults": { "unit": "none", "min": 0 }, "overrides": [] },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
          "id": 18,
          "options": {
            "legend": { "displayMode": "table", "placement": "bottom", "showLegend": true },
            "tooltip": { "mode": "single" }
          },
          "targets": [
            {
              "expr": "sum(increase(kube_pod_container_status_restarts_total{namespace=~\"$namespace\"}[30m])) by (pod)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ],
          "title": "Container Restarts (last 30m) - by Pod",
          "type": "timeseries"
        }
      ],
      "refresh": "30s",
      "schemaVersion": 39,
      "style": "dark",
      "tags": ["TFM", "app", "SLI", "SLO", "kubernetes"],
      "templating": {
        "list": [
          {
            "name": "namespace",
            "type": "query",
            "datasource": { "type": "prometheus", "name": "Prometheus" },
            "query": "label_values(kube_namespace_created, namespace)",
            "refresh": 1,
            "hide": 0,
            "includeAll": true,
            "multi": false,
            "allValue": ".*",
            "current": { "selected": true, "text": "All", "value": ".*" }
          },
          {
            "name": "ingress",
            "type": "query",
            "datasource": { "type": "prometheus", "name": "Prometheus" },
            "query": "label_values(nginx_ingress_controller_requests{namespace=~\"$namespace\"}, ingress)",
            "refresh": 1,
            "hide": 0,
            "includeAll": true,
            "multi": false,
            "allValue": ".*",
            "current": { "selected": true, "text": "All", "value": ".*" }
          },
          {
            "name": "deployment",
            "type": "query",
            "datasource": { "type": "prometheus", "name": "Prometheus" },
            "query": "label_values(kube_deployment_created{namespace=~\"$namespace\"}, deployment)",
            "refresh": 1,
            "hide": 0,
            "includeAll": false,
            "multi": false
          }
        ]
      },
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {
        "refresh_intervals": ["10s","30s","1m","5m","15m","30m","1h"],
        "time_options": ["5m","15m","30m","1h","6h","12h","24h","2d","7d","30d"]
      },
      "timezone": "",
      "title": "TFM - App SLI Overview",
      "uid": "tfm-app-sli-overview",
      "version": 1,
      "weekStart": ""
    }
